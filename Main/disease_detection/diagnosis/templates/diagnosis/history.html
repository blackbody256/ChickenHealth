{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Diagnosis History - Chicken Health Analysis{% endblock %}

{% block content %}
{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Diagnosis History - Chicken Health Analysis{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">


<div class="history-section">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-history"></i>
            Diagnosis History
        </h1>
        <p class="page-subtitle">
            View and manage your past chicken health diagnoses
        </p>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get" class="filter-grid">
            <div class="filter-group">
                <label for="date_from">From Date</label>
                <input type="date" id="date_from" name="date_from" value="{{ request.GET.date_from }}">
            </div>
            <div class="filter-group">
                <label for="date_to">To Date</label>
                <input type="date" id="date_to" name="date_to" value="{{ request.GET.date_to }}">
            </div>
            <div class="filter-group">
                <label for="disease_filter">Disease Type</label>
                <select id="disease_filter" name="disease_filter">
                    <option value="">All Diseases</option>
                    <option value="healthy" {% if request.GET.disease_filter == 'healthy' %}selected{% endif %}>Healthy</option>
                    <option value="coccidiosis" {% if request.GET.disease_filter == 'coccidiosis' %}selected{% endif %}>Coccidiosis</option>
                    <option value="salmonella" {% if request.GET.disease_filter == 'salmonella' %}selected{% endif %}>Salmonella</option>
                    <option value="newcastle" {% if request.GET.disease_filter == 'newcastle' %}selected{% endif %}>Newcastle Disease</option>
                </select>
            </div>
            <div class="filter-group">
                <button type="submit" class="filter-btn">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </form>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-value">{{ total_diagnoses }}</div>
            <div class="stat-label">Total Diagnoses</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ healthy_count }}</div>
            <div class="stat-label">Healthy Results</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ disease_count }}</div>
            <div class="stat-label">Disease Detected</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ avg_confidence|floatformat:1 }}%</div>
            <div class="stat-label">Avg. Confidence</div>
        </div>
    </div>

    <!-- History Grid -->
    <div class="history-grid">
        {% for diagnosis in diagnoses %}
            <div class="diagnosis-card">
                <div class="card-content">
                    <img src="{{ diagnosis.image.url }}" alt="Diagnosis Image" class="diagnosis-image">
                    
                    <div class="diagnosis-info">
                        <div class="diagnosis-title">
                            {{ diagnosis.disease_name }}
                            <span class="disease-badge {% if 'healthy' in diagnosis.disease_name|lower %}healthy{% else %}disease{% endif %}">
                                {% if 'healthy' in diagnosis.disease_name|lower %}
                                    <i class="fas fa-check-circle"></i> Healthy
                                {% else %}
                                    <i class="fas fa-exclamation-triangle"></i> Disease
                                {% endif %}
                            </span>
                        </div>
                        
                        <div class="diagnosis-meta">
                            <i class="fas fa-calendar"></i> {{ diagnosis.timestamp|date:"M d, Y" }}
                            <i class="fas fa-clock"></i> {{ diagnosis.timestamp|time:"g:i A" }}
                        </div>
                        
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: {{ diagnosis.confidence }}%"></div>
                        </div>
                        <div class="confidence-text">Confidence: {{ diagnosis.confidence|floatformat:1 }}%</div>
                    </div>
                    
                    <div class="card-actions">
                        <a href="{% url 'diagnosis:detail' diagnosis.id %}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> View Details
                        </a>
                        <a href="{% url 'diagnosis:reanalyze' diagnosis.id %}" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Re-analyze
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>No Diagnoses Found</h3>
                <p>You haven't performed any diagnoses yet. Start by uploading an image of chicken droppings for analysis.</p>
                <a href="{% url 'diagnosis:upload_predict' %}" class="btn btn-primary">
                    <i class="fas fa-camera"></i> Start Your First Diagnosis
                </a>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1" class="page-link">&laquo; First</a>
                <a href="?page={{ page_obj.previous_page_number }}" class="page-link">Previous</a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="page-link active">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}" class="page-link">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="page-link">Next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}" class="page-link">Last &raquo;</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}